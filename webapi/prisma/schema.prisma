generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum GrupoAcesso {
  SUPER_ROOT
  SUPER_ADMIN
  ADMIN
  GESTOR
  OPERACAO
}

enum AcaoPassagem {
  ENTRADA
  SAIDA
}

model CLICliente {
  CLICodigo    Int              @id @default(autoincrement())
  CLINome      String
  CLIDocumento String?          @unique
  CLIAtivo     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  instituicoes INSInstituicao[]
  acessos      USRAcesso[]
}

model INSInstituicao {
  INSCodigo        Int                   @id @default(autoincrement())
  CLICodigo        Int
  cliente          CLICliente            @relation(fields: [CLICodigo], references: [CLICodigo])
  INSNome          String
  INSCodigoExterno String?
  INSAtivo         Boolean               @default(true)
  createdAt        DateTime              @default(now())
  pessoas          PESPessoa[]
  matriculas       MATMatricula[]
  equipamentos     EQPEquipamento[]
  erpConfig        ERPConfiguracao[]
  acessos          USRAcesso[]
  passagens        REGRegistroPassagem[]
  cmdcomandoFilas  CMDComandoFila[]
}

model PESPessoa {
  PESCodigo            Int                   @id @default(autoincrement())
  PESIdExterno         String?
  PESNome              String
  PESNomeSocial        String?
  PESDocumento         String?               @unique
  PESEmail             String?
  PESTelefone          String?
  PESCelular           String?
  PESFotoBase64        String?
  PESFotoExtensao      String?
  PESGrupo             String?
  PESCartaoTag         String?
  PESAtivo             Boolean               @default(true)
  INSInstituicaoCodigo Int
  instituicao          INSInstituicao        @relation(fields: [INSInstituicaoCodigo], references: [INSCodigo])
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  deletedAt            DateTime?
  matriculas           MATMatricula[]
  passagens            REGRegistroPassagem[]
}

model MATMatricula {
  MATCodigo            Int            @id @default(autoincrement())
  PESCodigo            Int
  pessoa               PESPessoa      @relation(fields: [PESCodigo], references: [PESCodigo])
  MATNumero            String
  MATCurso             String?
  MATSerie             String?
  MATTurma             String?
  MATAtivo             Boolean        @default(true)
  INSInstituicaoCodigo Int
  instituicao          INSInstituicao @relation(fields: [INSInstituicaoCodigo], references: [INSCodigo])
  createdAt            DateTime       @default(now())
}

model EQPEquipamento {
  EQPCodigo            Int                   @id @default(autoincrement())
  EQPDescricao         String?
  EQPMarca             String?
  EQPModelo            String?
  EQPEnderecoIp        String?
  EQPAtivo             Boolean               @default(true)
  INSInstituicaoCodigo Int
  instituicao          INSInstituicao        @relation(fields: [INSInstituicaoCodigo], references: [INSCodigo])
  createdAt            DateTime              @default(now())
  passagens            REGRegistroPassagem[]
  cmdcomandoFilas      CMDComandoFila[]
}

model ERPConfiguracao {
  ERPCodigo            Int            @id @default(autoincrement())
  ERPSistema           String
  ERPUrlBase           String?
  ERPToken             String?
  ERPConfigJson        Json?
  INSInstituicaoCodigo Int
  instituicao          INSInstituicao @relation(fields: [INSInstituicaoCodigo], references: [INSCodigo])
  createdAt            DateTime       @default(now())
}

model USRUsuario {
  USRCodigo Int         @id @default(autoincrement())
  USRNome   String
  USREmail  String      @unique
  USRSenha  String
  createdAt DateTime    @default(now())
  acessos   USRAcesso[]
}

model USRAcesso {
  UACCodigo            Int             @id @default(autoincrement())
  USRCodigo            Int
  usuario              USRUsuario      @relation(fields: [USRCodigo], references: [USRCodigo], onDelete: Cascade)
  grupo                GrupoAcesso
  CLICodigo            Int?
  cliente              CLICliente?     @relation(fields: [CLICodigo], references: [CLICodigo])
  INSInstituicaoCodigo Int?
  instituicao          INSInstituicao? @relation(fields: [INSInstituicaoCodigo], references: [INSCodigo])
  createdAt            DateTime        @default(now())

  @@unique([USRCodigo, grupo, CLICodigo, INSInstituicaoCodigo])
}

model REGRegistroPassagem {
  REGCodigo            Int            @id @default(autoincrement())
  PESCodigo            Int
  pessoa               PESPessoa      @relation(fields: [PESCodigo], references: [PESCodigo])
  REGAcao              AcaoPassagem
  EQPCodigo            Int
  equipamento          EQPEquipamento @relation(fields: [EQPCodigo], references: [EQPCodigo])
  REGTimestamp         BigInt
  REGDataHora          DateTime
  INSInstituicaoCodigo Int
  instituicao          INSInstituicao @relation(fields: [INSInstituicaoCodigo], references: [INSCodigo])
  createdAt            DateTime       @default(now())
}

enum StatusComando {
  PENDENTE
  ENVIADO
  EXECUTADO
  ERRO
}

model CMDComandoFila {
  CMDCodigo            Int            @id @default(autoincrement())
  EQPCodigo            Int
  equipamento          EQPEquipamento @relation(fields: [EQPCodigo], references: [EQPCodigo])
  CMDVerb              String         @default("POST")
  CMDEndpoint          String
  CMDBody              Json?
  CMDContentType       String         @default("application/json")
  CMDStatus            StatusComando  @default(PENDENTE)
  CMDResultado         Json?
  INSInstituicaoCodigo Int
  instituicao          INSInstituicao @relation(fields: [INSInstituicaoCodigo], references: [INSCodigo])
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
}
